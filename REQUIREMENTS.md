# Trekka - 要件定義書

## プロジェクト概要
ReactベースのTodoアプリケーション。タスクをラベルごとにグループ化し、直感的なドラッグ&ドロップでタスク管理を行う。

## 認証システム要件 (2025-06-16追加)

### 認証フロー仕様
**アカウント作成フロー**:
1. 「アカウント作成」ボタンクリック → `localStorage: 'signup'`トリガー設定
2. メール/パスワード入力 → Supabase認証
3. 認証成功 → SignupComplete画面表示（「確認メールを送信しました」メッセージ）
4. 「始める」ボタン → ホーム画面遷移

**パスワードリセットフロー**:
1. 「パスワードリセットメールを送信」ボタンクリック → `localStorage: 'password_reset'`トリガー設定
2. メールアドレス入力 → リセットメール送信
3. メールリンククリック → `?reset=true`パラメータ付きURL
4. 新パスワード入力・確認 → パスワード更新
5. 更新完了 → ホーム画面に自動遷移（アラート表示なし）

**トリガー検出システム**:
- **LocalStorage**: ボタンクリック時にトリガー情報(`signup`/`password_reset`)を保存
- **URLパラメータ**: パスワードリセットリンクで`?reset=true`を検出
- **二重チェック**: 両方の情報を組み合わせて適切な画面判定
- **デバッグログ**: コンソールで認証状態とトリガー情報を詳細表示

### UI/UX要件
- **日本語完全対応**: すべての認証UI要素とメッセージを日本語化
- **エラーハンドリング**: メール送信頻度制限等の適切なエラー表示
- **レスポンシブ対応**: モバイル・デスクトップでの一貫した認証体験
- **セキュリティ**: 6文字以上のパスワード要求、メール確認必須

### 技術仕様
- **Supabase Auth UI**: `@supabase/auth-ui-react`による認証フォーム
- **状態管理**: AuthContextでの認証状態とトリガー管理
- **開発環境**: `skipConfirmation={import.meta.env.DEV}`でメール確認スキップ

## 基本要件

### 1. タスク管理機能
- **タスク登録**: タスク名、期間、ラベルの3つの情報で構成
- **一括作成**: モーダル内で複数タスクを同時作成可能
- **編集・削除**: 既存タスクの編集と削除機能
- **データ永続化**: Supabaseを使用したバックエンド連携

### 2. ラベルグループ機能
- **自動グループ化**: 同じラベル名のタスクを自動的にグループ化
- **グループ表示**: ラベル名とタスク数を表示
- **グループ作成**: 空のラベルグループを手動作成可能
- **グループ削除**: グループとその中のタスクを一括削除
- **グループ名変更**: ラベル名の変更（グループ内全タスクのラベルも同時更新）

### 3. ドラッグ&ドロップ機能（重要）
**ユーザー体験要件**:
- ✅ **即座の視覚フィードバック**: ドラッグ開始時にタスクがドロップ先に即座に表示される
- ❌ **禁止動作**: 「元の場所に戻る→移動する」という2段階動作は絶対に禁止
- ✅ **商用レベル品質**: Trello、Asana、Notion等と同等の滑らかな操作感
- ✅ **全デバイス対応**: マウス、トラックパッド、タッチデバイス全対応
- ✅ **ネイティブドラッグ無効化**: ブラウザ標準のドラッグ動作との競合を完全排除

**技術要件**:
- タスクを別のラベルグループにドラッグしてラベル変更
- ドラッグ中の視覚的フィードバック（ゴーストイメージ、ドロップゾーン強調）
- 操作ミス防止（編集ボタンとドラッグ操作の競合回避）

### 4. ユーザーインターフェース
- **レスポンシブデザイン**: モバイル・デスクトップ対応
- **固定ヘッダー**: スクロールしても常に表示
- **横スクロール**: グループが多い場合の水平スクロール
- **モダンデザイン**: Glassmorphism、グラデーション、滑らかなアニメーション
- **キーボードショートカット**: Cmd/Ctrl+N（新規作成）、Escape（モーダル閉じる）

### 5. データ管理
- **Supabase連携**: リアルタイムデータベース
- **ローカルストレージ**: グループ順序の永続化
- **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージ

## 技術スタック
- **フロントエンド**: React 19, TypeScript, Vite
- **ドラッグ&ドロップ**: @dnd-kit
- **バックエンド**: Supabase
- **スタイリング**: CSS3, CSS Grid, Flexbox
- **アイコン**: Lucide React
- **日付選択**: react-datepicker

## 開発原則
1. **ユーザー体験最優先**: 操作感の滑らかさを最重要視
2. **商用品質**: バグのない安定した動作
3. **一貫性**: 全ての操作で統一された挙動
4. **アクセシビリティ**: キーボード操作、スクリーンリーダー対応
5. **パフォーマンス**: 高速な応答性

## 現在の課題・要望
- [x] **根本的問題**: ドラッグ→元の位置に戻る→移動する（Trello風実装で解決）
- [x] **信頼性問題**: 10回中数回掴めない不安定性（マウスイベント基盤で解決）
- [x] **ユーザー体験**: 手放したら即座に移動先に表示されるべき（実装完了）

## ゼロベース設計方針
**現状分析**: @dnd-kitベースの複雑な実装は根本的な解決に至らない
**新方針**: HTML5ネイティブドラッグ&ドロップAPIでシンプル実装
- ブラウザネイティブ機能で確実性を重視
- 複雑な状態管理を排除
- 直感的な動作を最優先

## ゼロベース再実装完了
**実装内容**:
- @dnd-kit完全削除によるシンプル化
- HTML5 draggable属性 + onDragStart/onDrop イベント
- 状態管理を `draggedTask` 1つに簡素化
- ドラッグ中タスクを元グループから即座に非表示
- 「元の位置に戻る」動作を根本的に排除

**技術的変更**:
- `DndContext`, `SortableContext`, `DragOverlay` → 削除
- 複雑なコリジョン検出 → `elementFromPoint` + `closest` での確実な検出
- HTML5 draggable → マウスイベントベースでTrello風実装
- 多層状態管理 → 単一状態 `draggedTask` + マウス位置追跡

## Trello風ドラッグ&ドロップ実装
**Trelloの動作分析と模倣**:
1. マウスダウンでドラッグ開始、オフセット計算
2. マウス移動でゴーストイメージがマウスに追従
3. 元のカードは半透明で残存（完全には消さない）
4. マウスアップでドロップターゲット検出、即座に移動
5. アニメーションや「戻り動作」は一切なし

**実装方式**:
- `onMouseDown` → ドラッグ開始、座標オフセット記録
- `onMouseMove` → ゴーストイメージ位置更新
- `onMouseUp` → `elementFromPoint`でドロップ先検出
- `data-group-label`属性でターゲットグループ特定

## 最新の実装改善
- **リアルタイム視覚フィードバック**: `handleDragOver`でドラッグ中に即座にタスクがドロップ先に表示
- **2段階処理分離**: 視覚的移動（即座）とデータ永続化（`handleDragEnd`）を分離
- **状態管理強化**: `dragOverGroup`でドラッグオーバー状態を管理
- **エラー回復**: データベース更新失敗時の自動リロードで整合性保証
- **安全なドロップ処理**: ドロップターゲットなしの場合は元位置に戻る
- **拡張ドロップエリア**: グループ高さを画面全体に、下部に十分なスペース確保
- **点滅防止**: トランジション制御でスムーズな視覚フィードバック
- **正確な位置挿入**: `dragOverIndex`で挿入位置を精密制御
- **商用レベル品質**: 複雑な位置計算とエラーハンドリングを実装

## ドラッグ&ドロップの技術的課題分析
**問題**: ドラッグ&ドロップは見た目以上に複雑な技術領域
- **コリジョン検出**: 正確なドロップターゲット判定
- **位置計算**: 挿入インデックスの精密な算出
- **状態同期**: 視覚的状態とデータの整合性保証
- **エラー回復**: 失敗時の自動復旧メカニズム
- **デバイス差異**: マウス/タッチ/トラックパッドの挙動統一

**対策**: 段階的なアプローチで確実性を重視
1. シンプルな基本動作を確実に実装
2. 詳細なログ出力で動作を可視化
3. エラーケースの完全な処理
4. 商用アプリと同等の品質基準

## 完了済み機能
- [x] 基本的なタスクCRUD操作
- [x] ラベルグループ機能
- [x] モーダルベースの一括作成
- [x] ラベルグループ削除（タスクも含めて）
- [x] ネイティブドラッグの競合排除
- [x] レスポンシブデザイン
- [x] Supabase連携
- [x] **認証システム完全実装** (2025-06-16)
  - [x] アカウント作成・ログイン・パスワードリセット
  - [x] 日本語ローカライゼーション
  - [x] 適切な画面遷移とトリガー検出
  - [x] SignupComplete・PasswordReset画面
- [x] **UI改善** (2025-06-16)
  - [x] ラベル編集時の入力欄巨大化問題修正
  - [x] 文字数制限超過時の自動切り詰め機能
  - [x] タスク作成順序の修正（新→旧順）
  - [x] 一括作成モーダルの大幅改善
  - [x] フローティングボタンによる直感的操作